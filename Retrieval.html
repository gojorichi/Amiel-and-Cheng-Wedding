<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Photo Download Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8">

        <h1 class="text-3xl font-bold text-center text-gray-900 border-b pb-4 mb-4">
            Amiel and Rachel's Photo Retrieval
        </h1>

        <p id="status-message" class="text-center text-lg text-rose-600 mb-6">Initializing App...</p>

        <div id="links-container" class="space-space-y-4">
            <!-- Download links will be inserted here -->
        </div>
        
        <textarea id="links-textarea" rows="10" readonly class="hidden w-full p-3 mt-6 border rounded-lg bg-gray-50 text-sm focus:outline-none"></textarea>

        <div class="mt-6 flex justify-center space-x-4">
            <button id="copy-button" onclick="copyLinks()" disabled
                class="px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Copy All URLs
            </button>
            <button id="refresh-button" onclick="loadPhotos()" disabled
                class="px-6 py-3 border border-indigo-600 text-base font-medium rounded-lg shadow-sm text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Refresh List
            </button>
        </div>
        
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Global Vars ---
        let db, auth;
        let allLinks = [];
        const MAX_RETRIES = 5;
        let isAuthReady = false; 
        
        // Use provided global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const statusMessage = document.getElementById('status-message');
        const linksContainer = document.getElementById('links-container');
        const linksTextarea = document.getElementById('links-textarea');
        const copyButton = document.getElementById('copy-button');
        const refreshButton = document.getElementById('refresh-button');

        // --- Core Functions ---
        
        async function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Initializes Firebase and authenticates the user (in this case, the owner).
         */
        async function initializeFirebase() {
            // --- CRITICAL DEBUGGING CHECK ---
            console.log("--- DEBUG CONFIG CHECK START ---");
            const isConfigPresent = Object.keys(firebaseConfig).length > 0;
            const isTokenPresent = initialAuthToken !== null && initialAuthToken.length > 0;
            
            console.log(`[DEBUG] App ID: ${appId}`);
            console.log(`[DEBUG] Firebase Config Present: ${isConfigPresent}`);
            console.log(`[DEBUG] Auth Token Present: ${isTokenPresent}`);
            console.log("--- DEBUG CONFIG CHECK END ---");

            if (!isConfigPresent) {
                console.error("FATAL: Firebase configuration (__firebase_config) is missing or empty. Cannot proceed.");
                statusMessage.textContent = 'FATAL ERROR: Configuration missing. Please reload the entire environment.';
                refreshButton.disabled = true;
                return;
            }
            
            try {
                // 1. Init App
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Auth User (using custom token or anonymously)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Wait for Auth State and set flag
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        statusMessage.textContent = 'Authenticated. Fetching files...';
                        loadPhotos();
                    } else {
                        // This case shouldn't happen if the token is valid
                        statusMessage.textContent = 'Authentication failed. Please check environment.';
                        refreshButton.disabled = true;
                    }
                });

            } catch (error) {
                // Log the full error object for detailed troubleshooting
                console.error("Firebase Initialization Failed (Full Error):", error);
                statusMessage.textContent = 'ERROR: Initialization failed. See console for full details.';
            }
        }

        /**
         * Fetches all upload records from the public collection.
         */
        window.loadPhotos = async function() {
            // Ensure we are authenticated before attempting Firestore operations
            if (!db || !isAuthReady) {
                statusMessage.textContent = 'Waiting for authentication...';
                return; 
            }

            linksContainer.innerHTML = '';
            linksTextarea.value = '';
            allLinks = [];
            statusMessage.textContent = 'Fetching file records...';
            copyButton.disabled = true;
            refreshButton.disabled = true;

            const collectionPath = `/artifacts/${appId}/public/data/wedding_uploads`;
            const uploadsRef = collection(db, collectionPath);
            
            // Query for ALL documents in the public wedding_uploads collection
            const q = query(uploadsRef);
            
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) {
                        statusMessage.textContent = 'No photos have been uploaded yet.';
                        copyButton.disabled = false;
                        refreshButton.disabled = false;
                        return;
                    }
                    
                    // Process results
                    const linkStrings = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allLinks.push(data.downloadURL);

                        const card = `
                            <div class="p-3 border border-gray-200 rounded-lg bg-white shadow-sm">
                                <p class="text-sm font-semibold text-gray-700">${data.filename}</p>
                                <p class="text-xs text-gray-500">Uploaded by: ${data.userId.substring(0, 8)}...</p>
                                <a href="${data.downloadURL}" target="_blank" class="text-xs text-indigo-500 hover:text-indigo-700 truncate block mt-1">
                                    Click to Download
                                </a>
                            </div>
                        `;
                        linksContainer.innerHTML += card;
                        linkStrings.push(data.downloadURL);
                    });
                    
                    // Update Textarea with all links
                    linksTextarea.value = linkStrings.join('\n');
                    linksTextarea.classList.remove('hidden');

                    statusMessage.textContent = `Successfully loaded ${snapshot.size} photo records.`;
                    copyButton.disabled = false;
                    refreshButton.disabled = false;
                    return;

                } catch (error) {
                    console.error(`Attempt ${i + 1} to load records failed.`, error);
                    if (i < MAX_RETRIES - 1) {
                        statusMessage.textContent = `Failed to fetch records (Attempt ${i + 1}). Retrying...`;
                        await delay(Math.pow(2, i) * 1000); 
                    } else {
                         statusMessage.textContent = 'ERROR: Failed to load photo records after multiple retries. Check browser console for network/permission issues.';
                         refreshButton.disabled = false;
                    }
                }
            }
        }

        /**
         * Copies all download links to the clipboard.
         */
        window.copyLinks = function() {
            if (linksTextarea.value.length === 0) {
                statusMessage.textContent = "Nothing to copy!";
                return;
            }
            
            // Use execCommand('copy') as it's more reliable in iframe environments
            linksTextarea.select();
            document.execCommand('copy');
            statusMessage.textContent = "âœ… All photo URLs copied to clipboard!";
            setTimeout(() => statusMessage.textContent = `Successfully loaded ${allLinks.length} photo records.`, 3000);
        }
        
        // Initialize the app state when the page loads
        window.onload = initializeFirebase;

    </script>
</body>
</html>
