<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amiel and Rachel's Wedding</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="main-interface" class="w-full max-w-md bg-white rounded-xl shadow-2xl p-6 md:p-8 text-center">

        <!-- Camera Icon (Color updated for theme) -->
        <svg class="mx-auto h-16 w-16 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.865-1.531A2 2 0 0110.707 4h2.586a2 2 0 011.664.89l.865 1.531A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <h1 class="text-3xl font-bold mt-4 text-gray-900" id="prompt-title">Amiel and Rachel's Wedding</h1>
        
        <!-- The Initial Prompt Message (Content updated) -->
        <p class="mt-2 text-lg text-gray-600" id="prompt-message">
            Thank you so much for attending our wedding, please feel free to capture your images through the use of this QR so that we can see the experiences through your lens. There will be a limit of 15 photos per person.
        </p>

        <!-- Hidden File Input for Camera Activation -->
        <input type="file" id="camera-input" class="hidden" accept="image/*, video/*" capture="camera">

        <!-- Action Button (Color updated for theme) -->
        <button id="start-button" onclick="startCameraProcess()" 
            class="mt-6 w-full px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-rose-500 hover:bg-rose-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-rose-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
            Start Camera
        </button>

        <!-- Status and Result Area (Color updated for theme) -->
        <div id="status-area" class="mt-6 text-left p-4 bg-rose-50 rounded-lg hidden">
            <p class="font-semibold text-rose-800 flex justify-between">
                <span>Upload Status:</span>
                <span id="upload-counter" class="font-normal text-sm">Loading...</span>
            </p>
            <p id="upload-status" class="text-rose-700 text-sm mt-1">Initializing App...</p>
            <p id="file-info" class="text-xs text-gray-500 mt-2"></p>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Configuration ---
        const UPLOAD_LIMIT = 15;
        let uploadCount = 0; 

        // --- Firebase Global Vars ---
        let db, auth, storage;
        let userId = 'loading';
        
        // Use provided global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const cameraInput = document.getElementById('camera-input');
        const startButton = document.getElementById('start-button');
        const uploadStatus = document.getElementById('upload-status');
        const statusArea = document.getElementById('status-area');
        const fileInfo = document.getElementById('file-info');
        const uploadCounterSpan = document.getElementById('upload-counter');
        const MAX_RETRIES = 5;

        // --- Core Functions ---
        
        // Exponential backoff utility
        async function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // 1. Init App
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                // 2. Auth User (using custom token or anonymously)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Wait for Auth State and set userId
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Authenticated with UID:", userId);
                            unsubscribe(); // Stop listening after initial auth state is resolved
                            resolve();
                        }
                    });
                });
                
                // 4. Load persistent count
                await loadPersistentUploadCount();

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                uploadStatus.textContent = 'ERROR: Initialization failed. See console.';
                startButton.disabled = true;
            }
        }

        /**
         * Fetches the current number of user uploads from Firestore.
         */
        async function loadPersistentUploadCount() {
            if (!db || userId === 'loading') return;

            const collectionPath = `/artifacts/${appId}/public/data/wedding_uploads`;
            const uploadsRef = collection(db, collectionPath);
            
            // Query for documents uploaded by the current user
            const q = query(uploadsRef, where("userId", "==", userId));
            
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const snapshot = await getDocs(q);
                    uploadCount = snapshot.size;
                    updateCounterDisplay();
                    checkLimitAndTerminate();
                    uploadStatus.textContent = 'Ready to capture.';
                    startButton.disabled = false;
                    return;
                } catch (error) {
                    console.error(`Attempt ${i + 1} to load count failed.`, error);
                    if (i < MAX_RETRIES - 1) {
                        await delay(Math.pow(2, i) * 1000); // Exponential backoff
                    } else {
                         uploadStatus.textContent = 'ERROR: Failed to load photo limit count. Retrying...';
                    }
                }
            }
        }

        // Updates the counter text
        function updateCounterDisplay() {
            uploadCounterSpan.textContent = `(${uploadCount} of ${UPLOAD_LIMIT} uploads)`;
        }

        // Checks if the limit has been reached and updates UI if true
        function checkLimitAndTerminate() {
            if (uploadCount >= UPLOAD_LIMIT) {
                startButton.disabled = true;
                startButton.classList.remove('bg-rose-500', 'hover:bg-rose-600');
                startButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                startButton.textContent = 'Limit Reached (15 Photos)';
                uploadStatus.textContent = 'Limit reached. Thank you for sharing your 15 photos with us!';
                fileInfo.textContent = 'The capture portal is now closed for this session.';
                return true;
            }
            return false;
        }

        // This function runs when the user clicks the main button
        function startCameraProcess() {
            if (checkLimitAndTerminate()) {
                return; // Stop if limit is already reached
            }

            if (cameraInput) {
                statusArea.classList.remove('hidden');
                uploadStatus.textContent = 'Awaiting file capture from your camera...';
                
                // Programmatically click the hidden input to trigger the camera/file picker
                cameraInput.click();
            } else {
                uploadStatus.textContent = 'Error: Camera input element not found.';
            }
        }

        // Event listener for when a file is selected
        cameraInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            
            if (checkLimitAndTerminate()) {
                return;
            }

            if (file) {
                fileInfo.textContent = `Captured File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB, Type: ${file.type})`;
                uploadStatus.textContent = 'File captured successfully. Starting cloud upload...';
                startButton.disabled = true;
                startButton.textContent = 'Uploading...';

                uploadFileToDrive(file);
            } else {
                uploadStatus.textContent = 'Capture cancelled by user or no file selected.';
                fileInfo.textContent = '';
            }
        });

        /**
         * Uploads the file to Firebase Storage and saves metadata to Firestore.
         */
        async function uploadFileToDrive(file) {
            if (checkLimitAndTerminate()) return;
            if (!storage || !db || !userId) {
                simulateFailure("App not fully initialized. Try again.");
                return;
            }
            
            const timestamp = Date.now();
            const storagePath = `/artifacts/${appId}/public/uploads/${userId}/${timestamp}_${file.name}`;
            const storageRef = ref(storage, storagePath);

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    // 1. Upload the file to Storage
                    const snapshot = await uploadBytes(storageRef, file);
                    
                    // 2. Get the public download URL
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    // 3. Store metadata in Firestore
                    const metadata = {
                        userId: userId,
                        filename: file.name,
                        fileType: file.type,
                        fileSize: file.size,
                        downloadURL: downloadURL,
                        storagePath: storagePath,
                        uploadedAt: serverTimestamp()
                    };

                    const collectionPath = `/artifacts/${appId}/public/data/wedding_uploads`;
                    await addDoc(collection(db, collectionPath), metadata);

                    // Success! Update counter and UI
                    uploadCount++; 
                    simulateSuccess(downloadURL); 
                    return;

                } catch (error) {
                    console.error(`Attempt ${i + 1} to upload failed.`, error);
                    if (i < MAX_RETRIES - 1) {
                        uploadStatus.textContent = `Upload failed (Attempt ${i + 1}). Retrying in ${Math.pow(2, i)}s...`;
                        await delay(Math.pow(2, i) * 1000); // Exponential backoff
                    } else {
                        simulateFailure(error.message || "Failed to upload file after multiple retries.");
                    }
                }
            }
        }

        function simulateSuccess(downloadURL) {
            updateCounterDisplay();
            
            // Check if this was the final upload
            if (checkLimitAndTerminate()) {
                return;
            }
            
            uploadStatus.textContent = `✅ Upload ${uploadCount} Complete!`;
            fileInfo.innerHTML = `File is stored securely. (URL available in console for verification)`;
            
            startButton.textContent = 'New Capture';
            startButton.disabled = false;
            startButton.onclick = () => {
                // Reset for a new capture
                uploadStatus.textContent = 'Ready to capture.';
                fileInfo.textContent = '';
                startButton.textContent = 'Start Camera';
                startButton.onclick = startCameraProcess;
                cameraInput.value = null; 
            };
        }

        function simulateFailure(error = "Unknown error") {
            uploadStatus.textContent = `❌ Upload Failed: ${error}. Please try again.`;
            startButton.textContent = 'Try Again';
            startButton.disabled = false;
            startButton.onclick = startCameraProcess;
        }
        
        // Initialize the app state when the page loads
        window.onload = initializeFirebase;

    </script>
</body>
</html>
